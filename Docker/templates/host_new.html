{% extends "base.html" %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h4 class="mb-0">Cr√©er un host</h4>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('hosts_import_template') }}">T√©l√©charger le mod√®le</a>
    <a class="btn btn-outline-primary" href="{{ url_for('hosts_import') }}">Importer CSV</a>
  </div>
</div>

<form method="post" class="col-12 col-lg-8">
  <div class="row g-3">
    <div class="col-md-6">
      <label class="form-label">Hostname *</label>
      <input name="hostname" class="form-control" required />
    </div>
    <div class="col-md-6">
      <label class="form-label">Adresse IP *</label>
      <input name="ip" class="form-control" placeholder="192.168.1.10" required />
    </div>

    <div class="col-md-4">
      <label class="form-label">Port</label>
      <input name="port" class="form-control" value="161" />
    </div>
    <div class="col-md-8">
      <label class="form-label">Description</label>
      <input name="description" class="form-control" />
    </div>

    <!-- Communaut√© SNMP -->
    <div class="col-md-6">
      <label class="form-label">Communaut√© SNMP *</label>
      <input name="snmp_community" class="form-control" value="public" required />
    </div>

    <!-- Groupe / Type d‚Äô√©quipement -->
    <div class="col-md-6">
      <label class="form-label">Groupe / Type d‚Äô√©quipement</label>
      <div class="d-flex gap-2">
        <select name="group_id" class="form-select">
          <option value="">‚Äî Aucun ‚Äî</option>
          {% for g in groups %}
          <option value="{{ g.id }}">{{ g.name }}</option>
          {% endfor %}
        </select>
        <a class="btn btn-outline-secondary" href="{{ url_for('group_new') }}">+ Nouveau</a>
      </div>
      <div class="form-text">Permet d'adapter automatiquement les OID SNMP selon le type d'√©quipement.</div>
    </div>

    <!-- Cat√©gories SNMP -->
    <div class="col-12">
      <label class="form-label fw-bold">Cat√©gories SNMP *</label>
      <div class="d-flex flex-wrap gap-4">
        {% for cat in ["system", "cpu", "ram", "storage", "interfaces"] %}
        <div class="form-check">
          <input class="form-check-input snmp-cat" type="checkbox" name="snmp_categories" value="{{ cat }}" id="chk_{{ cat }}">
          <label class="form-check-label" for="chk_{{ cat }}">{{ cat|capitalize }}</label>
        </div>
        {% endfor %}
      </div>
      <div class="form-text">Cochez les cat√©gories que vous souhaitez superviser.</div>
    </div>

    <!-- üîπ Bloc Seuils dynamiques -->
    <div class="col-12 mt-4">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-light d-flex align-items-center justify-content-between">
          <h6 class="mb-0 fw-bold text-secondary">Personnalisation des seuils (%)</h6>
          <span class="text-muted small">S'affiche seulement pour les cat√©gories coch√©es</span>
        </div>
        <div class="card-body">
          <div id="thresholds-container" class="row g-4">
            <!-- Les sliders appara√Ætront ici dynamiquement -->
          </div>
        </div>
      </div>
    </div>

    <!-- Tags -->
    <div class="col-12 mt-3">
      <label class="form-label">Tags (s√©par√©s par des virgules)</label>
      <input name="tags" class="form-control" placeholder="prod, router, snmpv2" />
    </div>
  </div>

  <div class="mt-4">
    <button class="btn btn-primary" type="submit">Cr√©er</button>
    <a class="btn btn-link" href="{{ url_for('admin') }}">Annuler</a>
  </div>
</form>

<!-- üî∏ JS dynamique -->
<script>
  const categoriesWithThresholds = ["cpu", "ram", "storage"];
  const container = document.getElementById("thresholds-container");

  function createThresholdBlock(cat) {
    const block = document.createElement("div");
    block.className = "col-md-4 threshold-block";
    block.dataset.cat = cat;
    block.innerHTML = `
      <div class="border rounded-3 p-3 h-100 bg-light-subtle">
        <h6 class="text-capitalize fw-semibold mb-3">${cat}</h6>
        <div class="mb-2">
          <label class="form-label small mb-1 text-muted">Warning</label>
          <input type="range" name="threshold_${cat}_warning" class="form-range" min="0" max="100" value="85"
                 oninput="this.nextElementSibling.textContent = this.value">
          <span class="badge bg-warning text-dark">85</span>
        </div>
        <div>
          <label class="form-label small mb-1 text-muted">Critical</label>
          <input type="range" name="threshold_${cat}_critical" class="form-range" min="0" max="100" value="90"
                 oninput="this.nextElementSibling.textContent = this.value">
          <span class="badge bg-danger">90</span>
        </div>
      </div>`;
    return block;
  }

  function updateThresholdBlocks() {
    const selected = [...document.querySelectorAll(".snmp-cat:checked")].map(i => i.value);
    container.innerHTML = ""; // Vide le conteneur
    for (const cat of selected) {
      if (categoriesWithThresholds.includes(cat)) {
        container.appendChild(createThresholdBlock(cat));
      }
    }
  }

  // √âcoute les changements sur les cases √† cocher
  document.querySelectorAll(".snmp-cat").forEach(chk => {
    chk.addEventListener("change", updateThresholdBlocks);
  });
</script>
{% endblock %}
