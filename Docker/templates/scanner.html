{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold mb-0"><i class="bi bi-search"></i> Scanner le réseau (SNMP)</h4>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin') }}">Retour</a>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <form id="scan-form" class="row g-3">
        <div class="col-md-5">
          <label class="form-label">Plage réseau (ex: 192.168.1.0/24)</label>
          <input type="text" id="network" name="network" class="form-control" required placeholder="192.168.1.0/24">
        </div>
        <div class="col-md-3">
          <label class="form-label">Communauté SNMP</label>
          <input type="text" id="community" name="community" class="form-control" value="public">
        </div>
        <div class="col-md-2 d-grid align-self-end">
          <button id="start-btn" type="submit" class="btn btn-primary">Lancer le scan</button>
        </div>
        <div class="col-md-1 d-grid align-self-end">
          <button id="stop-btn" type="button" class="btn btn-outline-danger" disabled>Arrêter</button>
        </div>
        <div class="col-md-1 d-grid align-self-end">
          <button id="clear-btn" type="button" class="btn btn-outline-secondary" title="Vider les résultats"><i class="bi bi-trash"></i></button>
        </div>
      </form>
    </div>
  </div>

  <div id="progress-area" class="mb-3" style="display:none;">
    <div class="mb-2">Progression : <span id="progress-text">0 / 0</span></div>
    <div class="progress">
      <div id="progress-bar" class="progress-bar" role="progressbar" style="width:0%"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h6>Équipements SNMP détectés</h6>
      <div class="table-responsive">
        <table class="table table-sm table-hover" id="results-table">
          <thead>
            <tr>
              <th>IP</th>
              <th>Hostname</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('scan-form');
  const resultsTable = document.querySelector('#results-table tbody');
  const progressArea = document.getElementById('progress-area');
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');
  const startBtn = document.getElementById('start-btn');
  const stopBtn = document.getElementById('stop-btn');
  const clearBtn = document.getElementById('clear-btn');

  let evtSource = null;
  let scannedDevices = [];

  // Fonction pour sauvegarder les résultats
  function saveResults() {
    sessionStorage.setItem('scannerDevices', JSON.stringify(scannedDevices));
    sessionStorage.setItem('scannerCommunity', document.getElementById('community').value.trim());
  }

  // Fonction pour restaurer les résultats
  function loadResults() {
    const saved = sessionStorage.getItem('scannerDevices');
    const savedCommunity = sessionStorage.getItem('scannerCommunity');
    
    if (saved) {
      try {
        scannedDevices = JSON.parse(saved);
        const community = savedCommunity || 'public';
        
        // Restaurer les résultats dans le tableau
        resultsTable.innerHTML = '';
        scannedDevices.forEach(d => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${d.ip}</td><td>${d.sysname}</td><td><a class="btn btn-sm btn-outline-primary" href="/hosts/new?ip=${encodeURIComponent(d.ip)}&port=161&snmp_community=${encodeURIComponent(community)}&hostname=${encodeURIComponent(d.sysname)}">Ajouter</a></td>`;
          resultsTable.appendChild(tr);
        });

        // Afficher un message si des équipements ont été restaurés
        if (scannedDevices.length > 0) {
          progressArea.style.display = 'block';
          progressText.textContent = `${scannedDevices.length} équipements (session précédente)`;
          progressBar.style.width = '100%';
          progressBar.classList.add('bg-success');
        }
      } catch (e) {
        console.error('Erreur lors de la restauration des résultats:', e);
      }
    }
  }

  // Fonction pour ajouter un appareil détecté
  function addDevice(device, community) {
    scannedDevices.push(device);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${device.ip}</td><td>${device.sysname}</td><td><a class="btn btn-sm btn-outline-primary" href="/hosts/new?ip=${encodeURIComponent(device.ip)}&port=161&snmp_community=${encodeURIComponent(community)}&hostname=${encodeURIComponent(device.sysname)}">Ajouter</a></td>`;
    resultsTable.appendChild(tr);
    saveResults();
  }

  // Charger les résultats au démarrage
  loadResults();

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    
    // Réinitialiser les résultats pour un nouveau scan
    resultsTable.innerHTML = '';
    scannedDevices = [];
    sessionStorage.removeItem('scannerDevices');
    
    const network = document.getElementById('network').value.trim();
    const community = document.getElementById('community').value.trim() || 'public';
    if (!network) return alert('Entrez une plage réseau valide');

    // open EventSource
    const url = `/api/scan?network=${encodeURIComponent(network)}&community=${encodeURIComponent(community)}`;
    evtSource = new EventSource(url);

    progressArea.style.display = 'block';
    progressBar.classList.remove('bg-success');
    progressBar.classList.add('bg-primary');
    startBtn.disabled = true;
    stopBtn.disabled = false;

    evtSource.addEventListener('meta', e => {
      const data = JSON.parse(e.data);
      progressText.textContent = `0 / ${data.total}`;
      progressBar.style.width = '0%';
    });

    evtSource.addEventListener('progress', e => {
      const data = JSON.parse(e.data);
      progressText.textContent = `${data.done} / ${data.total}`;
      const pct = Math.round((data.done / data.total) * 100);
      progressBar.style.width = pct + '%';
    });

    evtSource.addEventListener('device', e => {
      const d = JSON.parse(e.data);
      addDevice(d, community);
    });

    evtSource.addEventListener('done', e => {
      const data = JSON.parse(e.data);
      progressText.textContent = `${data.done} / ${data.total} - Scan terminé`;
      progressBar.style.width = '100%';
      progressBar.classList.remove('bg-primary');
      progressBar.classList.add('bg-success');
      startBtn.disabled = false;
      stopBtn.disabled = true;
      if (evtSource) evtSource.close();
      saveResults();
    });

    evtSource.addEventListener('error', e => {
      console.error('SSE error', e);
      startBtn.disabled = false;
      stopBtn.disabled = true;
      if (evtSource) evtSource.close();
    });
  });

  stopBtn.addEventListener('click', () => {
    if (evtSource) {
      evtSource.close();
      evtSource = null;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      saveResults();
    }
  });

  // Bouton pour vider les résultats
  clearBtn.addEventListener('click', () => {
    if (confirm('Voulez-vous vraiment effacer tous les équipements détectés ?')) {
      scannedDevices = [];
      resultsTable.innerHTML = '';
      sessionStorage.removeItem('scannerDevices');
      sessionStorage.removeItem('scannerCommunity');
      progressArea.style.display = 'none';
      progressBar.style.width = '0%';
      progressText.textContent = '';
    }
  });
});
</script>

{% endblock %}
