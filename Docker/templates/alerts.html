{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Surveillance en temps r√©el</h4>
    <a class="btn btn-outline-primary btn-sm" href="{{ url_for('admin') }}">‚Üê Retour aux h√¥tes</a>
  </div>

  <!-- üîÅ Auto-refresh toutes les 15 s -->
  <script>
    setInterval(() => {
      window.location.reload();
    }, 15000);
  </script>

  <!-- üîç Filtres -->
  <form method="get" class="row g-2 align-items-center mb-4">
    <div class="col-md-3">
      <label class="form-label mb-0">Filtrer par gravit√©</label>
      <select name="severity" class="form-select" onchange="this.form.submit()">
        <option value="">Toutes</option>
        <option value="critical" {% if severity == 'critical' %}selected{% endif %}>Critique</option>
        <option value="warning" {% if severity == 'warning' %}selected{% endif %}>Avertissement</option>
        <option value="info" {% if severity == 'info' %}selected{% endif %}>Info</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label mb-0">Filtrer par statut</label>
      <select name="status" class="form-select" onchange="this.form.submit()">
        <option value="all" {% if status == 'all' %}selected{% endif %}>Toutes</option>
        <option value="active" {% if status == 'active' %}selected{% endif %}>Actives</option>
        <option value="resolved" {% if status == 'resolved' %}selected{% endif %}>R√©solues</option>
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label mb-0">Rechercher un host</label>
      <input type="text" name="q" class="form-control" value="{{ q or '' }}" placeholder="ex: serveur1" />
    </div>

    <div class="col-md-2 text-end">
      <button type="submit" class="btn btn-primary w-100 mt-3 mt-md-0">Filtrer</button>
    </div>
  </form>

  {% if alerts|length == 0 %}
    <div class="alert alert-info">
      <strong>Aucune alerte d√©tect√©e.</strong><br>
      Le poller SNMP s‚Äôex√©cute toutes les 15 secondes ‚Äî actualisez dans quelques instants.
    </div>
  {% else %}
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Horodatage (UTC)</th>
          <th>H√¥te</th>
          <th>Gravit√©</th>
          <th>Message</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody>
        {% for alert in alerts %}
          <tr class="
            {% if alert.resolved_at %}
              table-success
            {% elif alert.severity == 'critical' %}
              table-danger
            {% elif alert.severity == 'warning' %}
              table-warning
            {% else %}
              table-info
            {% endif %}
          ">
            <td>
              {{ alert.created_at.strftime("%Y-%m-%d %H:%M:%S") }}
              {% if alert.resolved_at %}
                <br><small class="text-success">‚úÖ R√©solue : {{ alert.resolved_at.strftime("%Y-%m-%d %H:%M:%S") }}</small>
              {% endif %}
            </td>
            <td>
              {% if alert.host %}
                <a href="{{ url_for('host_view', host_id=alert.host.id) }}">
                  {{ alert.host.hostname }}
                </a><br>
                <small class="text-muted">{{ alert.host.ip }}:{{ alert.host.port }}</small>
              {% else %}
                <em class="text-muted">H√¥te supprim√©</em>
              {% endif %}
            </td>
            <td>
              <span class="badge 
                {% if alert.severity == 'critical' %}bg-danger
                {% elif alert.severity == 'warning' %}bg-warning text-dark
                {% else %}bg-info text-dark{% endif %}
              ">
                {{ alert.severity|capitalize }}
              </span>
            </td>
            <td>{{ alert.message }}</td>
            <td>
              {% if alert.resolved_at %}
                <span class="text-success fw-bold">R√©tablie</span>
              {% else %}
                <span class="text-danger fw-bold">Active</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
</div>
{% endblock %}
