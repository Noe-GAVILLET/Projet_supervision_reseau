{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h4 class="mb-0">Localisation des équipements</h4>
  <div>
    <a class="btn btn-outline-secondary me-2" href="{{ url_for('admin') }}">Retour</a>
    {% if session.get('role') == 'admin' %}
    <a class="btn btn-primary" href="{{ url_for('host_new') }}">
      <i class="fas fa-plus me-1"></i> Ajouter un hôte
    </a>
    {% endif %}
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-9">
    <div class="card shadow-sm">
      <div class="card-body p-0">
        <div id="map" style="height: 600px;"></div>
      </div>
    </div>
  </div>

  <div class="col-lg-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="card-title">Hôtes (avec localisation)</h6>
        <div id="hostList" class="list-group list-group-flush">
          <!-- items populated by JS -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // parse hosts JSON payload placed in a separate script tag to avoid
    // Jinja-in-JS parsing problems in editors/tools
    const hostsPayload = document.getElementById('hosts-data');
    const hosts = hostsPayload ? JSON.parse(hostsPayload.textContent || '[]') : [];
    const map = L.map('map').setView([46.0, 2.0], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markers = {};
    const hostList = document.getElementById('hostList');

    hosts.forEach(h => {
      if (!h || !h.lat || !h.lon) return;
      try {
        const lat = parseFloat(h.lat);
        const lon = parseFloat(h.lon);
        if (Number.isNaN(lat) || Number.isNaN(lon)) return;

        const marker = L.marker([lat, lon]).addTo(map);
        marker.bindPopup(`<strong>${h.hostname}</strong><br/>IP: ${h.ip}<br/><a href="${window.location.origin + '/hosts/' + h.id}">Détails</a>`);
        markers[h.id] = marker;

        // build list item with icon
        if (hostList) {
          const a = document.createElement('a');
          a.href = '#';
          a.className = 'list-group-item list-group-item-action d-flex align-items-center';
          a.innerHTML = `
            <i class="fas fa-map-marker-alt text-primary me-2" aria-hidden="true"></i>
            <div class="flex-grow-1">
              <div class="fw-bold">${h.hostname}</div>
              <small class="text-muted">${h.ip}</small>
            </div>`;

          a.addEventListener('click', function (evt) {
            evt.preventDefault();
            try {
              marker.openPopup();
              map.setView([lat, lon], 13);
            } catch (e) { console.warn(e); }
          });

          hostList.appendChild(a);
        }
      } catch (e) { console.warn('invalid coord for', h, e); }
    });

    // fit bounds to the markers we actually created
    const groupMarkers = Object.values(markers);
    if (groupMarkers.length) {
      const group = L.featureGroup(groupMarkers);
      map.fitBounds(group.getBounds().pad(0.3));
    }
  });
</script>

<!-- JSON payload (kept outside of inline JS to avoid parsing issues) -->
<script id="hosts-data" type="application/json">{{ hosts|tojson|safe }}</script>

{% endblock %}
