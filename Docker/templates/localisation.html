{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h4 class="mb-0">Localisation des équipements</h4>
  <div>
    <a class="btn btn-outline-secondary me-2" href="{{ url_for('admin') }}">Retour</a>
    {% if session.get('role') == 'admin' %}
    <a class="btn btn-primary" href="{{ url_for('host_new') }}">
      <i class="bi bi-plus-lg me-1"></i> Ajouter un hôte
    </a>
    {% endif %}
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-9">
    <div class="card shadow-sm">
      <div class="card-body p-0">
        <div id="map" style="height: 600px;"></div>
      </div>
    </div>
  </div>

  <div class="col-lg-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="card-title">Hôtes (avec localisation)</h6>
        <div id="hostList" class="list-group list-group-flush">
          <!-- items populated by JS -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  /* small helper so the divIcon pin aligns nicely */
  .leaflet-div-icon svg {
    width: 20px;
    height: 28px;
    display: block;
    line-height: 1;
    filter: drop-shadow(0 1px 3px rgba(0,0,0,0.45));
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // parse hosts JSON payload placed in a separate script tag to avoid
    // Jinja-in-JS parsing problems in editors/tools
  const hostsPayload = document.getElementById('hosts-data');
  const hosts = hostsPayload ? JSON.parse(hostsPayload.textContent || '[]') : [];
  // debugging: print payload so we can inspect in browser console
  console.log('localisation hosts payload:', hosts);
    const map = L.map('map').setView([46.0, 2.0], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markers = {};
    const hostList = document.getElementById('hostList');

    // SVG pin generator and icon factory (defined once)
    function makePinSvg(w, h, fill) {
      return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="${w}" height="${h}" aria-hidden="true">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5A2.5 2.5 0 1 1 12 6.5a2.5 2.5 0 0 1 0 5z" fill="${fill}"/>
          </svg>`;
    }

    function createPinIconForZoom(zoom, fill) {
      const w = Math.max(12, Math.min(64, Math.round(zoom * 3)));
      const h = Math.round(w * 1.4);
      const svg = makePinSvg(w, h, fill);
      return L.divIcon({ className: 'custom-pin', html: svg, iconSize: [w, h], iconAnchor: [Math.round(w / 2), Math.round(h * 0.9)] });
    }

    hosts.forEach(h => {
      // accept numeric 0 but filter out null/undefined/non-numeric
      if (!h) return;
      const hasLat = h.lat !== null && h.lat !== undefined && h.lat !== '';
      const hasLon = h.lon !== null && h.lon !== undefined && h.lon !== '';
      if (!hasLat || !hasLon) return;
      try {
        const lat = parseFloat(h.lat);
        const lon = parseFloat(h.lon);
        if (Number.isNaN(lat) || Number.isNaN(lon)) return;

        // choose color by status (similar to admin view)
        const status = (h.status || 'unknown').toLowerCase();
        let color = '#6c757d'; // gray = unknown
        if (status === 'up') color = '#28a745';
        else if (status === 'warning') color = '#fd7e14';
        else if (status === 'down') color = '#dc3545';

        const initialIcon = createPinIconForZoom(map.getZoom(), color);
        const marker = L.marker([lat, lon], { icon: initialIcon }).addTo(map);
        marker.bindPopup(`<strong>${h.hostname}</strong><br/>IP: ${h.ip}<br/><a href="${window.location.origin + '/hosts/' + h.id}">Détails</a>`);
        markers[h.id] = { marker: marker, color: color };

        // build list item with icon
        if (hostList) {
          const a = document.createElement('a');
          a.href = '#';
          a.className = 'list-group-item list-group-item-action d-flex align-items-center';
          a.innerHTML = `
            <i class="bi bi-geo-alt-fill me-2" aria-hidden="true" style="color: ${color};"></i>
            <div class="flex-grow-1">
              <div class="fw-bold">${h.hostname}</div>
              <small class="text-muted">${h.ip}</small>
            </div>`;

          a.addEventListener('click', function (evt) {
            evt.preventDefault();
            try {
              marker.openPopup();
              map.setView([lat, lon], 13);
            } catch (e) { console.warn(e); }
          });

          hostList.appendChild(a);
        }
      } catch (e) { console.warn('invalid coord for', h, e); }
    });

    // fit bounds to the markers we actually created
    const groupMarkers = Object.values(markers).map(e => e.marker);
    if (groupMarkers.length) {
      const group = L.featureGroup(groupMarkers);
      map.fitBounds(group.getBounds().pad(0.3));
    } else {
      // no markers: show a helpful message in the host list
      if (hostList && hostList.children.length === 0) {
        const p = document.createElement('div');
        p.className = 'text-muted small p-2';
        p.textContent = 'Aucun hôte géolocalisé trouvé. Vérifiez que les hôtes ont des coordonnées (latitude/longitude) en base.';
        hostList.appendChild(p);
      }
    }

    // update marker icons on zoom so they scale with map zoom level
    function updateAllMarkerSizes() {
      const z = map.getZoom();
      Object.values(markers).forEach(entry => {
        try {
          const m = entry.marker;
          const fill = entry.color || '#6c757d';
          // recreate icon for this zoom
          const w = Math.max(12, Math.min(64, Math.round(z * 3)));
          const h = Math.round(w * 1.4);
          const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="${w}" height="${h}" aria-hidden="true"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5A2.5 2.5 0 1 1 12 6.5a2.5 2.5 0 0 1 0 5z" fill="${fill}"/></svg>`;
          const newIcon = L.divIcon({ className: 'custom-pin', html: svg, iconSize: [w, h], iconAnchor: [Math.round(w/2), Math.round(h*0.9)] });
          m.setIcon(newIcon);
        } catch (e) { console.warn('failed to update marker icon', e); }
      });
    }

    map.on('zoomend', updateAllMarkerSizes);
    // set initial sizes according to current zoom
    updateAllMarkerSizes();
  });
</script>

<!-- JSON payload (kept outside of inline JS to avoid parsing issues) -->
<script id="hosts-data" type="application/json">{{ hosts|tojson|safe }}</script>

{% endblock %}
