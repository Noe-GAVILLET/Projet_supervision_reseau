{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
  <h3 class="mb-4">Dashboard de supervision</h3>

  <!-- =======================
       WIDGETS DE STATISTIQUES
  ======================== -->
 <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-5 g-4 mb-4">
  <div class="col">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body text-center">
        <h6 class="text-muted mb-1">
          <i class="bi bi-hdd-network text-primary"></i> Total h√¥tes
        </h6>
        <h3 class="fw-bold text-primary">{{ total_hosts }}</h3>
      </div>
    </div>
  </div>

  <div class="col">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body text-center">
        <h6 class="text-muted mb-1">
          <i class="bi bi-check-circle-fill text-success"></i> UP
        </h6>
        <h3 class="fw-bold text-success">{{ hosts_up }}</h3>
      </div>
    </div>
  </div>
  <!-- WARNING card inserted between UP and DOWN -->
  <div class="col">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body text-center">
        <h6 class="text-muted mb-1">
          <i class="bi bi-exclamation-triangle-fill text-warning"></i> Warning
        </h6>
        <h3 class="fw-bold text-warning">{{ hosts_warning }}</h3>
      </div>
    </div>
  </div>

  <div class="col">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body text-center">
        <h6 class="text-muted mb-1">
          <i class="bi bi-x-octagon-fill text-danger"></i> DOWN
        </h6>
        <h3 class="fw-bold text-danger">{{ hosts_down }}</h3>
      </div>
    </div>
  </div>

  <div class="col">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body text-center">
        <h6 class="text-muted mb-1">
          <i class="bi bi-question-circle-fill text-secondary"></i> Inconnus
        </h6>
        <h3 class="fw-bold text-secondary">{{ hosts_unknown }}</h3>
      </div>
    </div>
  </div>
</div>


  <!-- =======================
       TABLEAU DES H√îTES
  ======================== -->
  {% if hosts %}
  <div class="card shadow-sm">
    <div class="d-flex justify-content-between align-items-center px-2 py-1 border-bottom bg-light rounded-top">
      <h5 class="mb-0">
        <i class="bi bi-hdd-network me-1"></i> Liste des h√¥tes supervis√©s
      </h5>

      <div class="d-flex align-items-center">
        <label class="me-2 small text-muted mb-0">Affichage uptime :</label>
        <select id="uptime-unit" class="form-select form-select-sm me-3" style="width:110px;">
          <option value="h" selected>heures</option>
          <option value="d">jours</option>
        </select>

        <a href="{{ url_for('export_hosts_csv') }}" class="btn btn-outline-success btn-sm px-3">
          <i class="bi bi-download me-1"></i> Exporter
        </a>
      </div>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Hostname</th>
              <th>IP:Port</th>
              <th>Groupe</th>
              <th>Cat√©gories SNMP</th>
              <th>Tags</th>
              <th>√âtat</th>

              {% if session.role == 'admin' %}
              <th class="text-end">Actions</th>
              {% else %}
              <th class="text-end">D√©tails</th>
              {% endif %}
            </tr>
          </thead>

          <tbody>
            {% for h in hosts %}
            <tr>
              <td>{{ h.hostname }}</td>
              <td>{{ h.ip }}:{{ h.port }}</td>
              <td>{{ h.group.name if h.group else "-" }}</td>

              <td>
                {% if h.snmp_categories %}
                  {% for c in h.snmp_categories %}
                    <span class="badge bg-info text-dark me-1">{{ c }}</span>
                  {% endfor %}
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>

              <td>
                {% if h.tags %}
                  {% for t in h.tags %}
                    <span class="badge bg-secondary me-1">{{ t.name }}</span>
                  {% endfor %}
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>

              <td class="align-middle">
                {# Afficher le statut √† partir de la colonne `h.status` (BDD) uniquement #}
                {% if h.status == 'down' %}
                  <span class="badge bg-danger me-2">
                    <i class="bi bi-x-octagon"></i> DOWN
                  </span>
                {% elif h.status == 'warning' %}
                  <span class="badge bg-warning text-dark me-2">
                    <i class="bi bi-exclamation-triangle-fill"></i> Warning
                  </span>
                {% elif h.status == 'up' %}
                  <span class="badge bg-success me-2">
                    <i class="bi bi-check-circle"></i> UP
                  </span>
                {% else %}
                  <span class="badge bg-secondary me-2">
                    <i class="bi bi-question-circle"></i> Inconnu
                  </span>
                {% endif %}

                {% if h.uptime_str and h.uptime_str != '‚Äî' %}
                  {# stocke les secondes pour conversion JS #}
                  <small class="text-muted uptime-display" data-uptime-seconds="{{ h.uptime_seconds }}">{{ h.uptime_str }}</small>
                {% endif %}
              </td>

              <!-- =======================
                   COLONNE ACTIONS
              ======================== -->
              {% if session.role == 'admin' %}
              <td class="text-end">

                {% if h.status == 'down' %}
                  <button class="btn btn-sm btn-secondary me-1" disabled>Injoignable</button>
                {% else %}
                  <a class="btn btn-sm btn-outline-primary me-1" href="{{ url_for('host_view', host_id=h.id) }}">
                    <i class="bi bi-eye"></i> View
                  </a>
                {% endif %}

                <a class="btn btn-sm btn-outline-secondary me-1" href="{{ url_for('host_edit', host_id=h.id) }}">
                  <i class="bi bi-pencil"></i> Edit
                </a>

                <form class="d-inline" method="post" action="{{ url_for('host_delete', host_id=h.id) }}"
                      onsubmit="return confirm('Supprimer d√©finitivement {{ h.hostname }} ?');">
                  <button class="btn btn-sm btn-outline-danger" type="submit">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </form>
              </td>

              {% else %}
              <!-- ===== OPERATEUR : UNIQUEMENT "VIEW" ===== -->
              <td class="text-end">
                {% if h.status == 'down' %}
                  <button class="btn btn-sm btn-secondary" disabled>Injoignable</button>
                {% else %}
                  <a class="btn btn-sm btn-outline-primary" href="{{ url_for('host_view', host_id=h.id) }}">
                    <i class="bi bi-eye"></i> View
                  </a>
                {% endif %}
              </td>
              {% endif %}

            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {% else %}
  <div class="alert alert-info mt-4">
    Aucun h√¥te pour le moment.
  </div>
  {% endif %}
</div>

<!-- üîÑ Rafra√Æchissement automatique -->
<script>
  setInterval(() => location.reload(), 15000);
</script>

<script>
// Permet d'afficher l'uptime en heures / jours / semaines selon la s√©lection
document.addEventListener('DOMContentLoaded', function () {
  const unitSelect = document.getElementById('uptime-unit');
  if (!unitSelect) return;

  function formatUptime(seconds, unit) {
    if (!seconds && seconds !== 0) return '‚Äî';
    const s = Number(seconds);
    if (unit === 'h') {
      const hours = Math.floor(s / 3600);
      const minutes = Math.floor((s % 3600) / 60);
      const secs = s % 60;
      return `depuis ${hours}h${String(minutes).padStart(2,'0')}m${String(secs).padStart(2,'0')}s`;
    }
    if (unit === 'd') {
      const days = Math.floor(s / 86400);
      const hours = Math.floor((s % 86400) / 3600);
      const minutes = Math.floor((s % 3600) / 60);
      const secs = s % 60;
  return `depuis ${days}d${hours}h${String(minutes).padStart(2,'0')}m${String(secs).padStart(2,'0')}s`;
    }
    return '‚Äî';
  }

  function updateAll() {
    const unit = unitSelect.value;
    document.querySelectorAll('.uptime-display').forEach(el => {
      const secs = el.dataset.uptimeSeconds ? parseInt(el.dataset.uptimeSeconds, 10) : null;
      el.textContent = formatUptime(secs, unit);
    });
  }

  unitSelect.addEventListener('change', updateAll);
  // auto-select unit based on largest uptime_seconds among hosts
  (function autoSelectUnit() {
    const els = Array.from(document.querySelectorAll('.uptime-display'));
    if (!els.length) {
      // no hosts with uptime -> just run update
      updateAll();
      return;
    }
    const max = els.reduce((acc, el) => {
      const s = el.dataset.uptimeSeconds ? parseInt(el.dataset.uptimeSeconds, 10) : 0;
      return Math.max(acc, isNaN(s) ? 0 : s);
    }, 0);

  // Choose default unit:
  // - days if >= 24 hours
  // - hours otherwise
  let defaultUnit = 'h';
  if (max >= 24 * 3600) defaultUnit = 'd';

    unitSelect.value = defaultUnit;
    updateAll();
  })();
});
</script>

{% endblock %}
