{% extends "base.html" %}

{% if error %}
<div class="alert alert-warning">
  {{ error }}
</div>
{% endif %}

{% block content %}
<body data-host-id="{{ host.id }}">

<div class="d-flex align-items-center justify-content-between mb-4">
  <h4 class="mb-0">Détails du host : {{ host.hostname }}</h4>
  <div>
    <a class="btn btn-outline-secondary me-2" href="{{ url_for('host_edit', host_id=host.id) }}">Modifier</a>
    <a class="btn btn-primary" href="{{ url_for('admin') }}">Retour</a>
  </div>
</div>

<!-- Infos principales -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <dl class="row mb-0">
      <dt class="col-sm-3">IP / Port</dt>
      <dd class="col-sm-9">{{ host.ip }}:{{ host.port }}</dd>

      <dt class="col-sm-3">Communauté SNMP</dt>
      <dd class="col-sm-9">{{ host.snmp_community }}</dd>

      <dt class="col-sm-3">Description</dt>
      <dd class="col-sm-9">{{ host.description or "—" }}</dd>

      <dt class="col-sm-3">Catégories</dt>
      <dd class="col-sm-9">
        {% if host.snmp_categories %}
          {% for c in host.snmp_categories %}
            <span class="badge bg-info text-dark me-1">{{ c }}</span>
          {% endfor %}
        {% else %}—{% endif %}
      </dd>
    </dl>
  </div>
</div>

<!-- Métriques SNMP -->
{% if metrics %}
  {% for category, values in metrics.items() %}
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title text-capitalize">{{ category }}</h5>

        <!-- SYSTEM (custom affichage lisible) -->
        {% if category == "system" %}
          <table class="table table-sm">
            <thead><tr><th>Champ</th><th>Valeur</th></tr></thead>
            <tbody>
              {% for label, val in system_data %}
                <tr>
                  <td>{{ label }}</td>
                  <td>{{ val }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}

        <!-- CPU -->
        {% if category == "cpu" %}
          <table class="table table-sm">
            <thead><tr><th>CPU</th><th>Charge</th></tr></thead>
            <tbody>
              {% for cpu_oid, load in values.items() %}
                <tr><td title="{{ cpu_oid }}">Core {{ loop.index }}</td><td>{{ load }}%</td></tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}

        <!-- RAM -->
        {% if category == "ram" %}
          <table class="table table-sm">
            <thead><tr><th>Type</th><th>Utilisé</th><th>Total</th><th>%</th></tr></thead>
            <tbody>
              {% for name, info in values.items() %}
                <tr>
                  <td>{{ name }}</td>
                  <td>{{ info.used }}</td>
                  <td>{{ info.total }}</td>
                  <td>
                    {% if info.total and info.total > 0 %}
                      {{ "%.1f"|format((info.used / info.total) * 100) }}%
                    {% else %}
                      —
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}

        <!-- STORAGE -->
        {% if category == "storage" %}
          <table class="table table-sm">
            <thead><tr><th>Nom</th><th>Utilisé</th><th>Total</th><th>%</th></tr></thead>
            <tbody>
              {% for name, info in values.items() %}
                <tr>
                  <td>{{ name }}</td>
                  <td>{{ info.used }}</td>
                  <td>{{ info.total }}</td>
                  <td>
                    {% if info.total and info.total > 0 %}
                      {{ "%.1f"|format((info.used / info.total) * 100) }}%
                    {% else %}
                      —
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}
        
        <!-- INTERFACES -->
        {% if category == "interfaces" %}
          <table class="table table-sm">
            <thead><tr><th>Interface</th><th>État</th></tr></thead>
            <tbody>
              {% for iface, state in values.items() %}
                <tr>
                  <td>{{ iface }}</td>
                  <td>
                    {% if state|string|lower in ["up", "1", "true"] %}
                      <span class="badge bg-success">Up</span>
                    {% else %}
                      <span class="badge bg-danger">Down</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}

        <!-- GRAPHE -->
        {% if category in ["cpu", "ram", "storage"] %}
          <canvas id="chart-{{ category }}" height="100"></canvas>
        {% endif %}
      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="alert alert-warning">Aucune métrique disponible pour cet hôte.</div>
{% endif %}

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<!-- Script de génération des courbes -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const categories = ["cpu", "ram", "storage"];
    const hostId = parseInt(document.body.dataset.hostId);

    categories.forEach(category => {
      fetch(`/api/poll/metrics/${hostId}/${category}?minutes=10`)
        .then(resp => resp.json())
        .then(data => {
          if (!data || data.length === 0) {
            console.warn(`[chart] Pas de données pour ${category}`);
            return;
          }

          const byMetric = {};

          // Regrouper les valeurs par métrique
          data.forEach(entry => {
            if (!byMetric[entry.metric]) {
              byMetric[entry.metric] = [];
            }
            byMetric[entry.metric].push({
              x: entry.timestamp,
              y: entry.value
            });
          });

          const isPercent = (category === 'ram' || category === 'storage');

          const datasets = Object.entries(byMetric).map(([metric, points], index) => {
            return {
              label: category === 'cpu' ? `Core ${index + 1}` : metric,
              data: points.map(p => ({
                x: p.x,
                y: isPercent ? (p.y > 1 ? Math.min(100, p.y / 1000) : p.y * 100) : p.y
              })),
              fill: false,
              tension: 0.2
            };
          });

          const yAxisOptions = {
            beginAtZero: true,
            max: (category === 'cpu' || category === 'ram' || category === 'storage') ? 100 : undefined,
            title: {
              display: true,
              text: (category === 'cpu') ? 'Charge CPU (%)' : 'Utilisation (%)'
            }
          };

          const ctx = document.getElementById(`chart-${category}`);
          if (ctx) {
            new Chart(ctx, {
              type: 'line',
              data: { datasets },
              options: {
                responsive: true,
                plugins: {
                  title: {
                    display: true,
                    text: `Historique ${category.toUpperCase()} (10 min)`
                  },
                  tooltip: {
                    callbacks: {
                      label: function (context) {
                        return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                      }
                    }
                  }
                },
                scales: {
                  x: {
                    type: 'time',
                    time: { unit: 'minute' },
                    title: { display: true, text: 'Temps' }
                  },
                  y: yAxisOptions
                }
              }
            });
          }
        })
        .catch(err => console.error(`Erreur ${category} :`, err));
    });
  });
</script>


</body>
{% endblock %}
